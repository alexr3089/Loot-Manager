const ws = new WebSocket(`wss://${location.host}`);
let items = [];

ws.onopen = () => console.log('Connected to WebSocket');
ws.onerror = (err) => console.error('WebSocket error:', err);
ws.onmessage = function(event) {
    try {
        const data = JSON.parse(event.data);
        if (data.type === 'lootListUpdate') {
            items = data.items;
            renderTable();
        }
        if (data.type === 'itemUpdate') {
            items[data.index] = data;
            renderTable();
        }
    } catch (err) {
        console.error('WebSocket message error:', err);
    }
};

function renderTable() {
    const table = document.getElementById('itemTable');
    table.innerHTML = '';
    items.forEach((item, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.looter}</td>
            <td><a href="https://eq.magelo.com/item/${item.id}" class="mageloLink" target="_blank">${item.name}</a></td>
            <td><input type="text" value="${item.recipient || ''}" onchange="updateItem(${i})" /></td>
            <td><input type="checkbox" ${item.distributed ? 'checked' : ''} onchange="updateItem(${i})" /></td>
        `;
        table.appendChild(row);
    });
    // Delay tooltip scan for DOM stability
    setTimeout(() => {
        if (window.mageloTooltip) mageloTooltip.scan();
    }, 0);
}

function updateItem(index) {
    const row = document.getElementById('itemTable').rows[index];
    const recipient = row.cells[2].querySelector('input[type="text"]').value;
    const distributed = row.cells[3].querySelector('input[type="checkbox"]').checked;
    ws.send(JSON.stringify({
        type: 'itemUpdate',
        index,
        recipient,
        distributed
    }));
}

document.getElementById('logUploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const file = document.getElementById('logFile').files[0];
    if (!file) return alert('No file selected.');
    const formData = new FormData();
    formData.append('logFile', file);
    fetch('/upload-log', {
        method: 'POST',
        body: formData
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        return res.json();
    })
    .then(data => {
        if (data.status === 'ok') {
            console.log('Log uploaded successfully.');
            alert('Log uploaded successfully. Items will appear in the table.');
        } else {
            alert('Upload failed: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Upload error:', err);
        alert('Upload error: ' + err.message);
    });
});
